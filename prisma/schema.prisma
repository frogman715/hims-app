// ==========================
// HANMARINE INTEGRATED MANAGEMENT SYSTEM (HIMS) v2
// PRISMA SCHEMA - SINGLE SOURCE OF TRUTH
// Version 2.0 - November 2025
// ==========================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================
// ENUMS
// ==========================

enum Role {
  DIRECTOR
  CDMO
  OPERATIONAL
  ACCOUNTING
  HR
  CREW_PORTAL
  QMR
  HR_ADMIN
  SECTION_HEAD
  STAFF
}

enum DataSensitivity {
  RED // Highly Sensitive (passport, medical, full SEA, salary breakdown)
  AMBER // Sensitive (personal data, disciplinary cases, certificates)
  GREEN // Internal/Normal (public vessel info, procedures)
}

enum CrewStatus {
  STANDBY
  ONBOARD
  OFF_SIGNED
  BLOCKED
}

enum DocumentReceiptCrewStatus {
  NEW
  EX_CREW
}

enum ContractStatus {
  DRAFT
  ACTIVE
  COMPLETED
  TERMINATED
  CANCELLED
}

enum ContractKind {
  SEA // Seafarer Employment Agreement (carried onboard, MLC compliant)
  OFFICE_PKL // PKL used for Hubla / office documentation
}

enum SeaType {
  KOREA
  BAHAMAS_PANAMA
  TANKER_LUNDQVIST
  OTHER
}

enum DisciplinaryAction {
  WARNING
  REPRIMAND
  SUSPENSION
  DISMISSAL
  FINE
}

enum InsuranceType {
  PANDI_CLUB
  HEALTH_INSURANCE
  ACCIDENT_INSURANCE
  LIFE_INSURANCE
}

enum WageComponent {
  BASIC_WAGE
  FIXED_OVERTIME
  MONTHLY_WAGE
  LEAVE_PAY
  SPECIAL_ALLOWANCE
  BONUS
}

enum DocumentCategory {
  PERSONAL
  CERTIFICATE
  MEDICAL
  VISA
  CONTRACT
  TRAINING
  DISPATCH
  FINANCIAL
  OTHER
}

enum DocumentTypeCode {
  PASSPORT
  SEAMAN_BOOK
  STCW_BST
  STCW_AFF
  STCW_MEFA
  STCW_SCRB
  COP_TANKER
  KOSMA
  MEDICAL_RESULT
  VISA
  SCHENGEN_VISA_NL
  DEPHUB_CERTIFICATE
  PKL_CONTRACT
  SEA
  TRAINING_NOK
  TRAINING_SAFETY_DECL
  TRAINING_MEDICAL_HISTORY
  TRAINING_GENERAL_EDU
  TRAINING_RECORD
  TRAINING_SCHEDULE
  RETURN
}

enum PaymentStatus {
  DRAFT
  PENDING
  PAID
  PARTIALLY_PAID
  CANCELLED
}

enum ExpenseType {
  OFFICE
  CREW_EXCHANGE
  MEDICAL
  HOTEL
  TRANSPORT
  VISA
  TICKET
  AGENT_FEE
  OTHER
}

enum ApplicationStatus {
  RECEIVED // Baru masuk, belum di-review
  REVIEWING // Sedang di-review HR
  INTERVIEW // Dijadwalkan interview
  PASSED // Lulus interview
  OFFERED // Ditawarkan posisi
  ACCEPTED // Diterima oleh seafarer
  REJECTED // Ditolak
  CANCELLED // Dibatalkan
}

enum InterviewStatus {
  SCHEDULED // Sudah dijadwalkan
  CONDUCTED // Sudah dilaksanakan
  PASSED // Lulus
  FAILED // Tidak lulus
  CANCELLED // Dibatalkan
}

enum PrepareJoiningStatus {
  PENDING // Belum mulai
  DOCUMENTS // Sedang siapkan dokumen
  MEDICAL // Medical check-up
  TRAINING // Training/orientation
  TRAVEL // Atur travel (tiket, hotel, transport)
  READY // Siap berangkat
  DISPATCHED // Sudah dikirim
  CANCELLED // Dibatalkan
}

enum WorkflowStatus {
  DRAFT
  SUBMITTED
  REVIEWED
  APPROVED
  REJECTED
  CLOSED
}

enum QualityDocumentStatus {
  DRAFT
  ACTIVE
  OBSOLETE
}

enum AcknowledgementStatus {
  PENDING
  ACKNOWLEDGED
  REVOKED
}

enum AttendanceStatus {
  PRESENT
  SICK
  EMERGENCY_LEAVE
  ABSENT
  WORK_FROM_HOME
  ON_LEAVE
}

enum LeaveType {
  SICK
  EMERGENCY
  ANNUAL
  UNPAID
  OTHER
}

enum LeaveStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
}

enum DisciplinarySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum DisciplinaryCaseStatus {
  OPEN
  UNDER_REVIEW
  ACTION_TAKEN
  CLOSED
}

enum PermissionAccessLevel {
  NO_ACCESS
  VIEW_ACCESS
  EDIT_ACCESS
  FULL_ACCESS
}

// ==========================
// DOCUMENT CONTROL SYSTEM
// ==========================

enum DocumentControlStatus {
  DRAFT
  FOR_APPROVAL
  APPROVED
  ACTIVE
  OBSOLETE
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  REVOKED
}

enum RetentionPeriod {
  THREE_MONTHS
  SIX_MONTHS
  ONE_YEAR
  TWO_YEARS
  THREE_YEARS
  FIVE_YEARS
  SEVEN_YEARS
  TEN_YEARS
  PERMANENT
}

// ==========================
// POINT 4.3 - AUDIT & NONCONFORMITY SYSTEM
// ==========================

enum ComplianceAuditType {
  INTERNAL
  EXTERNAL
  COMPLIANCE
  MANAGEMENT_REVIEW
  RISK_ASSESSMENT
}

enum ComplianceAuditStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum NonConformityStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  VERIFIED
  CLOSED
}

enum NCCorrectiveActionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  VERIFIED
  CLOSED
}

enum NCFindingSeverity {
  CRITICAL
  MAJOR
  MINOR
  OBSERVATION
}

// ==========================
// POINT 4.4 - HR COMPLIANCE MANAGEMENT
// ==========================

enum TrainingType {
  MANDATORY
  RECOMMENDED
  SKILL_DEVELOPMENT
  INDUCTION
  REFRESHER
}

enum TrainingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  EXPIRED
  OVERDUE
}

enum CertificationType {
  STCW
  PROFESSIONAL
  SAFETY
  MEDICAL
  OPERATIONAL
  COMPLIANCE
}

enum CertificationStatus {
  ACTIVE
  EXPIRING
  EXPIRED
  REVOKED
  PENDING_RENEWAL
}

enum ComplianceGapType {
  TRAINING
  CERTIFICATION
  DOCUMENTATION
  COMPETENCY
  AUDIT_FINDING
}

// ==========================
// POINT 4.5 - SUPPLIER MANAGEMENT
// ==========================

enum SupplierStatus {
  PROSPECT
  APPROVED
  CONDITIONAL
  SUSPENDED
  DEACTIVATED
}

enum SupplierType {
  EQUIPMENT
  SERVICE
  CONSUMABLE
  SPARE_PARTS
  TRAINING
  INSPECTION
  OTHER
}

enum SupplierAuditStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  PASSED
  FAILED
  CONDITIONAL_PASS
}

enum SupplierPOStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  ORDERED
  DELIVERED
  INVOICED
  PAID
  CANCELLED
}

// ==========================
// AUTH / USER
// ==========================

model User {
  id            String  @id @default(cuid())
  email         String  @unique
  name          String
  role          Role
  isSystemAdmin Boolean @default(false) // System admin override
  isActive      Boolean @default(true)
  password      String // Hashed password

  // Audit relations
  documentReceivings             DocumentReceiving[]
  documentReceipts               DocumentReceipt[]           @relation("documentReceiptsCreated")
  transportLogs                  TransportLog[]
  activityLogs                   ActivityLog[]
  officeExpenses                 OfficeExpense[]
  interviews                     Interview[]
  requestedReplacements          CrewReplacement[]           @relation("requestedBy")
  approvedReplacements           CrewReplacement[]           @relation("approvedBy")
  createdWorkflows               Workflow[]                  @relation("WorkflowCreatedBy")
  workflowTransitions            WorkflowTransition[]        @relation("WorkflowTransitionsActor")
  auditLogs                      AuditLog[]                  @relation("AuditLogActor")
  manualVersionsCreated          HgqsManualVersion[]         @relation("ManualCreatedBy")
  manualVersionsUploaded         HgqsManualVersion[]         @relation("ManualUploadedBy")
  manualVersionsApproved         HgqsManualVersion[]         @relation("ManualApprovedBy")
  proceduresCreated              HgqsProcedure[]             @relation("ProcedureCreatedBy")
  proceduresOwned                HgqsProcedure[]             @relation("ProcedureOwner")
  guidelinesCreated              HgqsGuideline[]             @relation("GuidelineCreatedBy")
  guidelinesOwned                HgqsGuideline[]             @relation("GuidelineOwner")
  guidelineAssignmentsCreated    HgqsGuidelineAssignment[]   @relation("GuidelineAssignmentCreatedBy")
  guidelineAssignmentsGiven      HgqsGuidelineAssignment[]   @relation("GuidelineAssignedBy")
  guidelineAssignmentsReceived   HgqsGuidelineAssignment[]   @relation("GuidelineAssignedToUser")
  policyAcknowledgements         HgqsPolicyAcknowledgement[] @relation("GuidelineAcknowledgementAssignee")
  policyAcknowledgementsCreated  HgqsPolicyAcknowledgement[] @relation("GuidelineAcknowledgementCreatedBy")
  policyAcknowledgementsApproved HgqsPolicyAcknowledgement[] @relation("GuidelineAcknowledgedBy")
  attendanceLogs                 HgqsAttendanceLog[]         @relation("AttendanceEmployee")
  attendanceRecordsCreated       HgqsAttendanceLog[]         @relation("AttendanceRecordedBy")
  attendanceRecordsAuthored      HgqsAttendanceLog[]         @relation("AttendanceCreatedBy")
  leaveRequests                  HgqsLeaveRequest[]          @relation("LeaveEmployee")
  leaveSubmissions               HgqsLeaveRequest[]          @relation("LeaveSubmittedBy")
  leaveRecordsCreated            HgqsLeaveRequest[]          @relation("LeaveCreatedBy")
  leaveReviews                   HgqsLeaveRequest[]          @relation("LeaveReviewedBy")
  leaveApprovals                 HgqsLeaveRequest[]          @relation("LeaveApprovedBy")
  disciplinaryCasesReported      HgqsDisciplinaryCase[]      @relation("DisciplinaryReportedBy")
  disciplinaryCasesAgainst       HgqsDisciplinaryCase[]      @relation("DisciplinaryReportedAgainst")
  disciplinaryCasesCreated       HgqsDisciplinaryCase[]      @relation("DisciplinaryCreatedBy")
  disciplinaryCasesClosed        HgqsDisciplinaryCase[]      @relation("DisciplinaryClosedBy")
  rolePermissionsCreated         RoleModulePermission[]      @relation("RolePermissionCreatedBy")

  // Phase 1: Risk Management (ISO 9001 Clause 6.1)
  risksCreated         Risk[]         @relation("RiskCreatedBy")
  riskActionsOwned     RiskAction[]   @relation("RiskActionOwner")
  riskReviewsPerformed RiskReview[]   @relation("RiskReviewedBy")
  riskAuditLogs        RiskAuditLog[] @relation("RiskAuditLogBy")

  // Phase 1: Internal Audit (ISO 9001 Clause 9.2)
  auditReportsApproved AuditReport[] @relation("AuditReportApprovedBy")

  // Phase 1: Crewing Procedures Digitization
  crewingProceduresUpdated CrewingProcedure[]  @relation("CrewingProcedureUpdatedBy")
  crewingChecklistsSubmitted CrewingChecklist[] @relation("ChecklistSubmittedBy")
  crewingChecklistsApproved  CrewingChecklist[] @relation("ChecklistApprovedBy")

  // Phase 2: HGF Forms & Documents
  hgfSubmissionsSubmitted   HGFSubmission[]   @relation("HGFSubmissionSubmittedBy")
  hgfSubmissionsApproved    HGFSubmission[]   @relation("HGFSubmissionApprovedBy")
  hgfSubmissionsRejected    HGFSubmission[]   @relation("HGFSubmissionRejectedBy")
  hgfSubmissionsRevisionsAsked HGFSubmission[] @relation("HGFSubmissionRevisionsAskedBy")
  documentsUploaded         DocumentUpload[]   @relation("DocumentUploadUploadedBy")
  documentsVerified         DocumentUpload[]   @relation("DocumentUploadVerifiedBy")
  formTemplatesCreated      FormTemplate[]    @relation("FormTemplateCreatedBy")
  hgfSubmissionAuditLogs    HGFSubmissionAuditLog[]

  // Phase 3: Quality Management System (QMS)
  qmsDocumentsReviewed      QMSDocument[]     @relation("QMSDocumentReviewedBy")
  nonconformitiesAssigned   NonconformityRecord[] @relation("NonconformityAssignedTo")
  nonconformitiesVerified   NonconformityRecord[] @relation("NonconformityVerifier")
  nonconformityAuditLogs    NonconformityAuditLog[] @relation("NonconformityAuditLogBy")
  auditTrails               AuditTrail[]
  qmsReportsApproved        QMSReport[]       @relation("QMSReportApprovedBy")

  // Phase 4.2: Document Control System
  documentsCreated         DocumentControl[] @relation("DocumentCreatedBy")
  documentRevisionsCreated DocumentRevision[] @relation("DocumentRevisionCreatedBy")
  documentApprovalsAssignedTo DocumentApproval[] @relation("DocumentApprovalAssignedTo")
  documentApprovalsApprovedBy DocumentApproval[] @relation("DocumentApprovalApprovedBy")
  documentDistributionsReceived DocumentDistribution[] @relation("DocumentDistributionRecipient")
  documentAcknowledgements DocumentAcknowledgement[] @relation("DocumentAcknowledgement")

  // Phase 4.3: Audit & Nonconformity System
  auditLedBy                  ComplianceAudit[]          @relation("AuditLeadAuditor")
  auditFindingsAssignedTo     ComplianceAuditFinding[]   @relation("AuditFindingAssignedTo")
  nonconformitiesAssignedToNC NonConformity[]            @relation("NonConformityAssignedTo")
  nonconformitiesVerifiedBy   NonConformity[]            @relation("NonConformityVerifiedBy")
  correctiveActionsAssignedTo NCCorrectiveAction[]       @relation("CorrectiveActionAssignedTo")
  correctiveActionsVerifiedBy NCCorrectiveAction[]       @relation("CorrectiveActionVerifiedBy")

  // Phase 4.4: HR Compliance Management
  employeeTrainings           EmployeeTraining[]         @relation("EmployeeTraining")
  employeeCertifications      Certification[]            @relation("EmployeeCertification")
  complianceGapsEmployee      ComplianceGap[]            @relation("ComplianceGapEmployee")
  complianceGapsAssignedTo    ComplianceGap[]            @relation("ComplianceGapAssignedTo")

  // Phase 4.5: Supplier Management
  suppliersApprovedBy         Supplier[]                 @relation("SupplierApprovedBy")
  supplierAuditsPerformed     SupplierAudit[]            @relation("SupplierAuditor")
  purchaseOrdersCreated       SupplierPurchaseOrder[]    @relation("POCreatedBy")
  purchaseOrdersApproved      SupplierPurchaseOrder[]    @relation("POApprovedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================
// CREW MANAGEMENT
// ==========================

model Crew {
  id                       String          @id @default(cuid())
  fullName                 String
  dateOfBirth              DateTime?
  placeOfBirth             String?
  nationality              String?
  passportNumber           String?
  passportExpiry           DateTime?
  seamanBookNumber         String?
  seamanBookExpiry         DateTime?
  rank                     String
  status                   CrewStatus      @default(STANDBY)
  phone                    String?
  email                    String?
  address                  String?
  emergencyContact         String?
  bloodType                String?
  heightCm                 Int?
  weightKg                 Int?
  coverallSize             String?
  shoeSize                 String?
  waistSize                String?
  emergencyContactName     String?
  emergencyContactRelation String?
  emergencyContactPhone    String?
  sensitivity              DataSensitivity @default(AMBER)
  photoUrl                 String?
  slug                     String?         @unique

  // Relations
  documents           CrewDocument[]
  medicalChecks       MedicalCheck[]
  visaApplications    VisaApplication[]
  dispatches          Dispatch[]
  salaries            CrewSalary[]
  leavePays           LeavePay[]
  replacements        CrewReplacement[]    @relation("crewReplacement")
  replacementFor      CrewReplacement[]    @relation("replacementCrew")
  assignments         Assignment[]
  applications        Application[]
  interviews          Interview[]
  orientations        Orientation[]
  recruitments        Recruitment[]
  attendances         Attendance[]
  disciplinaryCases   DisciplinaryRecord[]
  insuranceRecords    InsuranceRecord[]
  contracts           EmploymentContract[]
  prepareJoinings     PrepareJoining[]
  exchangeExpenses    ExchangeExpense[]
  documentReceipts    DocumentReceipt[]
  documentReceivings  DocumentReceiving[]
  transportLogs       TransportLog[]
  externalCompliances ExternalCompliance[]

  // HGQS Relations
  communicationLogs CommunicationLog[]
  signOffs          CrewSignOff[]
  checklists        CrewingChecklist[] // Phase 1: Digitize procedures
  hgfSubmissions    HGFSubmission[] // Phase 2: HGF Forms
  documentUploads   DocumentUpload[] // Phase 2: Documents
  
  // Phase 3: QMS Relations
  qmsDocuments      QMSDocument[]
  nonconformities   NonconformityRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DocumentType {
  id             String           @id @default(cuid())
  code           DocumentTypeCode @unique
  name           String
  category       DocumentCategory
  description    String?
  isRequired     Boolean          @default(false)
  validityMonths Int? // How many months valid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CrewDocument {
  id          String          @id @default(cuid())
  crewId      String
  docType     String // Document type code
  docNumber   String // Document number
  issueDate   DateTime?
  expiryDate  DateTime?
  remarks     String?
  fileUrl     String? // File storage URL
  isActive    Boolean         @default(true)
  sensitivity DataSensitivity @default(AMBER)

  crew Crew @relation(fields: [crewId], references: [id])
  
  // Phase 3: QMS Relations
  qmsDocuments QMSDocument[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================
// MEDICAL & VISA
// ==========================

model MedicalCheck {
  id          String          @id @default(cuid())
  crewId      String
  checkDate   DateTime
  expiryDate  DateTime
  clinicName  String
  doctorName  String?
  result      String // PASS/FAIL/PENDING
  remarks     String?
  fileUrl     String?
  sensitivity DataSensitivity @default(RED)

  crew Crew @relation(fields: [crewId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VisaApplication {
  id              String          @id @default(cuid())
  crewId          String
  country         String
  visaType        String
  applicationDate DateTime
  issueDate       DateTime?
  expiryDate      DateTime?
  status          String          @default("PENDING") // PENDING/APPROVED/REJECTED
  remarks         String?
  fileUrl         String?
  sensitivity     DataSensitivity @default(AMBER)

  crew Crew @relation(fields: [crewId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================
// CONTRACTS & EMPLOYMENT
// ==========================

model EmploymentContract {
  id                String          @id @default(cuid())
  contractNumber    String          @unique
  crewId            String
  vesselId          String?
  principalId       String?
  rank              String
  basicWage         Float
  currency          String          @default("USD")
  contractStart     DateTime
  contractEnd       DateTime
  status            ContractStatus  @default(DRAFT)
  contractKind      ContractKind    @default(SEA)
  seaType           SeaType?
  maritimeLaw       String?
  cbaReference      String?
  wageScaleHeaderId String?
  guaranteedOTHours Int?
  overtimeRate      String?
  onboardAllowance  Float?
  homeAllotment     Float?
  specialAllowance  Float?
  templateVersion   String?
  signDate          DateTime?
  remarks           String?
  fileUrl           String?
  sensitivity       DataSensitivity @default(AMBER)

  crew            Crew             @relation(fields: [crewId], references: [id])
  vessel          Vessel?          @relation(fields: [vesselId], references: [id])
  principal       Principal?       @relation(fields: [principalId], references: [id])
  wageScaleHeader WageScaleHeader? @relation(fields: [wageScaleHeaderId], references: [id])
  salaries        CrewSalary[]
  leavePays       LeavePay[]
  agencyFees      AgencyFee[]
  wageScaleItems  WageScaleItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================
// WAGE SCALES
// ==========================

model WageScaleHeader {
  id          String  @id @default(cuid())
  name        String
  principalId String?
  rank        String
  isActive    Boolean @default(true)

  principal Principal?           @relation(fields: [principalId], references: [id])
  items     WageScaleItem[]
  contracts EmploymentContract[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WageScaleItem {
  id                String        @id @default(cuid())
  wageScaleHeaderId String
  contractId        String?
  component         WageComponent
  amount            Float
  currency          String        @default("USD")
  frequency         String        @default("MONTHLY") // MONTHLY, CONTRACT
  isActive          Boolean       @default(true)

  wageScaleHeader WageScaleHeader     @relation(fields: [wageScaleHeaderId], references: [id])
  contract        EmploymentContract? @relation(fields: [contractId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================
// VESSEL & PRINCIPAL MANAGEMENT
// ==========================

model Vessel {
  id          String          @id @default(cuid())
  name        String
  imoNumber   String? // International Maritime Organization number
  flag        String // ex: "INDONESIA", "PANAMA"
  type        String // ex: "TANKER", "BULK CARRIER"
  dwt         Float? // Deadweight tonnage
  gt          Float? // Gross tonnage
  principalId String? // Reference to Principal
  status      String          @default("ACTIVE") // ACTIVE, INACTIVE, UNDER_REPAIR
  sensitivity DataSensitivity @default(GREEN)

  principal        Principal?              @relation(fields: [principalId], references: [id])
  assignments      Assignment[]
  contracts        EmploymentContract[]
  insuranceRecords InsuranceRecord[]
  agencyAgreements AgencyAgreementVessel[]
  prepareJoinings  PrepareJoining[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Principal {
  id                 String          @id @default(cuid())
  name               String
  country            String
  contactPerson      String?
  email              String?
  phone              String?
  address            String?
  taxId              String?
  registrationNumber String?
  agreementDate      DateTime?
  agreementExpiry    DateTime?
  status             String          @default("ACTIVE")
  sensitivity        DataSensitivity @default(GREEN)

  vessels          Vessel[]
  contracts        EmploymentContract[]
  agencyAgreements AgencyAgreement[]
  wageScales       WageScaleHeader[]
  agencyFees       AgencyFee[]
  assignments      Assignment[]
  insuranceRecords InsuranceRecord[]
  applications     Application[]
  prepareJoinings  PrepareJoining[]
  formTemplates    PrincipalFormTemplate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================
// OPERATIONAL MODULES
// ==========================

model Assignment {
  id          String    @id @default(cuid())
  crewId      String
  vesselId    String
  principalId String?
  rank        String
  startDate   DateTime
  endDate     DateTime?
  status      String    @default("ACTIVE")
  remarks     String?

  crew      Crew       @relation(fields: [crewId], references: [id])
  vessel    Vessel     @relation(fields: [vesselId], references: [id])
  principal Principal? @relation(fields: [principalId], references: [id])

  // HGQS Relations
  signOffs CrewSignOff[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Application {
  id              String            @id @default(cuid())
  crewId          String
  position        String // Target rank/position
  vesselType      String? // Vessel type preference
  principalId     String? // Target principal
  applicationDate DateTime          @default(now())
  status          ApplicationStatus @default(RECEIVED)
  reviewedBy      String? // User ID who reviewed
  reviewedAt      DateTime?
  remarks         String?
  attachments     String? // JSON array of file paths

  crew      Crew       @relation(fields: [crewId], references: [id])
  principal Principal? @relation(fields: [principalId], references: [id])
  checklists CrewingChecklist[] // Phase 1: Digitize procedures
  hgfSubmissions HGFSubmission[] @relation("HGFSubmission") // Phase 2: HGF Forms

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Interview {
  id             String          @id @default(cuid())
  crewId         String
  applicationId  String? // Link to application
  interviewerId  String // User ID
  scheduledDate  DateTime
  conductedDate  DateTime?
  status         InterviewStatus @default(SCHEDULED)
  score          Int? // Interview score (0-100)
  technicalScore Int? // Technical assessment
  attitudeScore  Int? // Attitude/behavior
  englishScore   Int? // English proficiency
  remarks        String?
  recommendation String? // Recommend to hire or not
  attachments    String? // JSON array of interview notes/files

  crew        Crew @relation(fields: [crewId], references: [id])
  interviewer User @relation(fields: [interviewerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Orientation {
  id        String    @id @default(cuid())
  crewId    String
  startDate DateTime
  endDate   DateTime?
  status    String    @default("IN_PROGRESS")
  remarks   String?

  crew Crew @relation(fields: [crewId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Recruitment {
  id              String   @id @default(cuid())
  crewId          String
  recruiterId     String // User ID
  recruitmentDate DateTime
  status          String   @default("IN_PROGRESS")
  remarks         String?

  crew Crew @relation(fields: [crewId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PrepareJoining {
  id           String               @id @default(cuid())
  crewId       String
  vesselId     String?
  principalId  String?
  assignmentId String? // Link to assignment
  status       PrepareJoiningStatus @default(PENDING)

  // Document checklist
  passportValid     Boolean @default(false)
  seamanBookValid   Boolean @default(false)
  certificatesValid Boolean @default(false)
  medicalValid      Boolean @default(false)
  visaValid         Boolean @default(false)

  // Medical
  medicalCheckDate DateTime?
  medicalExpiry    DateTime?
  medicalRemarks   String?

  // Training/Orientation
  orientationDate      DateTime?
  orientationCompleted Boolean   @default(false)
  trainingRemarks      String?

  // Travel arrangements
  departureDate     DateTime?
  departurePort     String?
  arrivalPort       String?
  flightNumber      String?
  ticketBooked      Boolean   @default(false)
  ticketBookedDate  DateTime?
  hotelBooked       Boolean   @default(false)
  hotelName         String?
  transportArranged Boolean   @default(false)
  transportDetails  String?

  // Additional
  remarks     String?
  attachments String? // JSON array of file paths

  crew      Crew                 @relation(fields: [crewId], references: [id])
  vessel    Vessel?              @relation(fields: [vesselId], references: [id])
  principal Principal?           @relation(fields: [principalId], references: [id])
  forms     PrepareJoiningForm[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Principal Form Templates (per owner)
model PrincipalFormTemplate {
  id           String  @id @default(cuid())
  principalId  String
  formName     String // e.g., "Medical History Checking List"
  formCategory String // MEDICAL, TRAINING, DECLARATION, SAFETY
  templatePath String // Path to template file in form_reference/
  isRequired   Boolean @default(true)
  displayOrder Int     @default(0)
  description  String?

  principal       Principal            @relation(fields: [principalId], references: [id])
  formSubmissions PrepareJoiningForm[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Form Submission & Approval
model PrepareJoiningForm {
  id               String             @id @default(cuid())
  prepareJoiningId String
  templateId       String
  formData         Json // Auto-filled data from crew
  status           FormApprovalStatus @default(DRAFT)
  submittedBy      String? // User ID who submitted
  submittedAt      DateTime?
  reviewedBy       String? // User ID who reviewed
  reviewedAt       DateTime?
  approvedBy       String? // User ID who approved
  approvedAt       DateTime?
  rejectionReason  String?
  finalPdfPath     String? // Path to generated PDF after approval
  version          Int                @default(1)

  prepareJoining PrepareJoining        @relation(fields: [prepareJoiningId], references: [id], onDelete: Cascade)
  template       PrincipalFormTemplate @relation(fields: [templateId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum FormApprovalStatus {
  DRAFT // Auto-filled, not yet submitted
  SUBMITTED // Submitted for review
  UNDER_REVIEW // Being reviewed by CDMO/Director
  CHANGES_REQUESTED // Need edits
  APPROVED // Approved, ready to download
  REJECTED // Rejected
}

model Dispatch {
  id           String   @id @default(cuid())
  crewId       String
  vesselId     String?
  dispatchDate DateTime
  port         String
  flightNumber String?
  status       String   @default("COMPLETED")
  remarks      String?

  crew Crew @relation(fields: [crewId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================
// ACCOUNTING MODULES
// ==========================

model CrewSalary {
  id          String        @id @default(cuid())
  crewId      String
  contractId  String?
  month       Int
  year        Int
  basicWage   Float
  overtime    Float         @default(0)
  allowances  Float         @default(0)
  deductions  Float         @default(0)
  totalAmount Float
  currency    String        @default("USD")
  status      PaymentStatus @default(DRAFT)
  paidDate    DateTime?
  remarks     String?

  crew     Crew                @relation(fields: [crewId], references: [id])
  contract EmploymentContract? @relation(fields: [contractId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LeavePay {
  id         String        @id @default(cuid())
  crewId     String
  contractId String?
  leaveType  String // ANNUAL, SICK, EMERGENCY
  startDate  DateTime
  endDate    DateTime
  days       Int
  amount     Float
  currency   String        @default("USD")
  status     PaymentStatus @default(DRAFT)
  paidDate   DateTime?
  remarks    String?

  crew     Crew                @relation(fields: [crewId], references: [id])
  contract EmploymentContract? @relation(fields: [contractId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AgencyFee {
  id          String    @id @default(cuid())
  principalId String?
  contractId  String?
  feeType     String // "ONBOARD" or "RECRUITING"
  amount      Float
  currency    String    @default("USD")
  percentage  Float?
  description String?
  dueDate     DateTime
  paidDate    DateTime?
  status      String    @default("PENDING")
  remarks     String?

  principal Principal?          @relation(fields: [principalId], references: [id])
  contract  EmploymentContract? @relation(fields: [contractId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OfficeExpense {
  id          String        @id @default(cuid())
  userId      String // Who created this expense
  expenseType ExpenseType
  amount      Float
  currency    String        @default("USD")
  description String
  expenseDate DateTime
  receiptUrl  String?
  status      PaymentStatus @default(DRAFT)
  approvedBy  String? // User ID
  approvedAt  DateTime?

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ExchangeExpense {
  id           String        @id @default(cuid())
  crewId       String
  amount       Float
  currency     String        @default("USD")
  exchangeRate Float
  idrAmount    Float
  expenseDate  DateTime
  description  String
  status       PaymentStatus @default(DRAFT)

  crew Crew @relation(fields: [crewId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================
// INSURANCE
// ==========================

model InsuranceRecord {
  id              String        @id @default(cuid())
  crewId          String?
  vesselId        String?
  principalId     String?
  insuranceType   InsuranceType
  provider        String // P&I Club name, Insurance company
  policyNumber    String
  coverageAmount  Float?
  currency        String        @default("USD")
  startDate       DateTime
  expiryDate      DateTime
  premiumAmount   Float?
  premiumCurrency String        @default("USD")
  status          String        @default("ACTIVE")
  coverageDetails String?

  crew      Crew?      @relation(fields: [crewId], references: [id])
  vessel    Vessel?    @relation(fields: [vesselId], references: [id])
  principal Principal? @relation(fields: [principalId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================
// AGENCY AGREEMENT & BUSINESS MODELS
// ==========================

model AgencyAgreement {
  id                    String   @id @default(cuid())
  principalId           String
  principalName         String
  principalAddress      String?
  agentName             String   @default("PT HANMARINE GLOBAL INDONESIA")
  agentAddress          String?
  effectiveDate         DateTime
  expiryDate            DateTime
  agreementNumber       String?
  cbaReference          String?
  pniClub               String?
  notes                 String?
  terminationConditions String?
  fileUrl               String?
  status                String   @default("ACTIVE")

  principal Principal               @relation(fields: [principalId], references: [id])
  vessels   AgencyAgreementVessel[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AgencyAgreementVessel {
  id                String @id @default(cuid())
  agencyAgreementId String
  vesselId          String

  agencyAgreement AgencyAgreement @relation(fields: [agencyAgreementId], references: [id])
  vessel          Vessel          @relation(fields: [vesselId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================
// DISCIPLINARY MANAGEMENT
// ==========================

model DisciplinaryRecord {
  id           String             @id @default(cuid())
  crewId       String
  vesselId     String?
  incidentDate DateTime
  reportedBy   String // User ID
  description  String
  action       DisciplinaryAction
  severity     String // MINOR, MAJOR, CRITICAL
  status       String             @default("OPEN")
  resolution   String?
  resolvedBy   String? // User ID
  resolvedAt   DateTime?

  crew Crew @relation(fields: [crewId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================
// HR MODULES
// ==========================

model Employee {
  id         String   @id @default(cuid())
  fullName   String
  position   String
  department String
  email      String?
  phone      String?
  hireDate   DateTime
  status     String   @default("ACTIVE")

  attendances Attendance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Attendance {
  id         String    @id @default(cuid())
  crewId     String?
  employeeId String?
  date       DateTime
  checkIn    DateTime?
  checkOut   DateTime?
  status     String    @default("PRESENT") // PRESENT, ABSENT, LATE

  crew     Crew?     @relation(fields: [crewId], references: [id])
  employee Employee? @relation(fields: [employeeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CrewReplacement {
  id                String    @id @default(cuid())
  crewId            String
  replacementCrewId String?
  reason            String
  requestedBy       String // User ID
  approvedBy        String? // User ID
  approvedAt        DateTime?
  status            String    @default("PENDING")
  remarks           String?

  crew            Crew  @relation("crewReplacement", fields: [crewId], references: [id])
  replacementCrew Crew? @relation("replacementCrew", fields: [replacementCrewId], references: [id])
  requester       User  @relation("requestedBy", fields: [requestedBy], references: [id])
  approver        User? @relation("approvedBy", fields: [approvedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================
// NATIONAL HOLIDAYS
// ==========================

model NationalHoliday {
  id          String   @id @default(cuid())
  country     String   @default("INDONESIA")
  holidayName String
  holidayDate DateTime
  isRecurring Boolean  @default(true)
  description String?
  paidLeave   Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================
// AUDIT & LOGGING
// ==========================

model DocumentReceipt {
  id               String                    @id @default(cuid())
  crewId           String
  crewName         String
  crewRank         String?
  phone            String?
  email            String?
  vesselName       String?
  crewStatus       DocumentReceiptCrewStatus @default(NEW)
  lastSignOffDate  DateTime?
  lastSignOffPort  String?
  wearpackSize     String?
  shoeSize         String?
  waistSize        String?
  notes            String?
  deliveryLocation String?
  deliveryDate     DateTime?
  handedOverByName String?
  receivedByName   String?
  createdById      String?

  crew      Crew                  @relation(fields: [crewId], references: [id])
  items     DocumentReceiptItem[]
  createdBy User?                 @relation("documentReceiptsCreated", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DocumentReceiptItem {
  id                String    @id @default(cuid())
  receiptId         String
  orderIndex        Int       @default(0)
  certificateName   String
  certificateNumber String?
  issueDate         DateTime?
  expiryDate        DateTime?
  remarks           String?

  receipt DocumentReceipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)
}

model DocumentReceiving {
  id         String   @id @default(cuid())
  crewId     String
  documentId String
  receivedBy String // User ID
  receivedAt DateTime
  remarks    String?

  crew Crew @relation(fields: [crewId], references: [id])
  user User @relation(fields: [receivedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TransportLog {
  id             String   @id @default(cuid())
  crewId         String
  transportType  String // AIRPORT_TRANSFER, HOTEL_TRANSFER
  pickupDate     DateTime
  pickupTime     String?
  pickupLocation String
  dropLocation   String?
  driverName     String?
  vehicleNumber  String?
  status         String   @default("COMPLETED")
  loggedBy       String // User ID

  crew Crew @relation(fields: [crewId], references: [id])
  user User @relation(fields: [loggedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ActivityLog {
  id         String  @id @default(cuid())
  userId     String
  action     String
  entityType String
  entityId   String
  details    String?
  ipAddress  String?

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Workflow {
  id            String         @id @default(cuid())
  resourceType  String
  resourceId    String
  currentStatus WorkflowStatus @default(DRAFT)
  createdBy     String

  creator     User                 @relation("WorkflowCreatedBy", fields: [createdBy], references: [id])
  transitions WorkflowTransition[]

  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  hgqsManualVersions         HgqsManualVersion[]
  hgqsProcedures             HgqsProcedure[]
  hgqsGuidelines             HgqsGuideline[]
  hgqsPolicyAcknowledgements HgqsPolicyAcknowledgement[]
  hgqsLeaveRequests          HgqsLeaveRequest[]
  hgqsDisciplinaryCases      HgqsDisciplinaryCase[]

  @@index([resourceType, resourceId])
}

model WorkflowTransition {
  id         String          @id @default(cuid())
  workflowId String
  actorId    String
  fromStatus WorkflowStatus?
  toStatus   WorkflowStatus
  notes      String?         @db.Text
  metadata   Json?

  workflow Workflow @relation(fields: [workflowId], references: [id])
  actor    User     @relation("WorkflowTransitionsActor", fields: [actorId], references: [id])

  createdAt DateTime @default(now())

  @@index([workflowId])
  @@index([actorId])
}

model AuditLog {
  id            String @id @default(cuid())
  actorUserId   String
  action        String
  entityType    String
  entityId      String
  metadataJson  Json?
  oldValuesJson Json?
  newValuesJson Json?

  actor User @relation("AuditLogActor", fields: [actorUserId], references: [id])

  createdAt DateTime @default(now())

  @@index([entityType, entityId])
}

model RoleModulePermission {
  id          String                @id @default(cuid())
  role        Role
  moduleKey   String
  level       PermissionAccessLevel @default(NO_ACCESS)
  createdById String

  createdBy User @relation("RolePermissionCreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([role, moduleKey])
  @@index([moduleKey])
  @@index([role])
}

// ==========================
// FINANCIAL DOCUMENTS
// ==========================

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  clientId      String
  amount        Float
  currency      String        @default("USD")
  issueDate     DateTime
  dueDate       DateTime
  status        PaymentStatus @default(DRAFT)
  paidDate      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model StatementOfAccount {
  id        String        @id @default(cuid())
  soaNumber String        @unique
  clientId  String
  period    String
  amount    Float
  currency  String        @default("USD")
  issueDate DateTime
  status    PaymentStatus @default(DRAFT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PettyCash {
  id          String        @id @default(cuid())
  amount      Float
  currency    String        @default("USD")
  description String
  expenseDate DateTime
  approvedBy  String?
  status      PaymentStatus @default(DRAFT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AuditFile {
  id          String @id @default(cuid())
  fileName    String
  fileType    String
  fileUrl     String
  uploadedBy  String
  auditPeriod String
  status      String @default("ACTIVE")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================
// EXTERNAL COMPLIANCE SYSTEMS
// ==========================

model ExternalCompliance {
  id              String               @id @default(cuid())
  crewId          String
  systemType      ComplianceSystemType
  certificateId   String? // External system certificate ID
  issueDate       DateTime?
  expiryDate      DateTime?
  status          ComplianceStatus     @default(PENDING)
  verificationUrl String? // URL to verify certificate
  notes           String?

  crew Crew @relation(fields: [crewId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ComplianceSystemType {
  KOSMA_CERTIFICATE // Korea 3-hour online training certificate
  DEPHUB_CERTIFICATE // Indonesian Dephub Seafarer Certificate (online verification)
  SCHENGEN_VISA_NL // Netherlands Schengen Visa (travel document tracking)
}

enum ComplianceStatus {
  PENDING
  VERIFIED
  EXPIRED
  REJECTED
}

// ==========================
// HGQS QUALITY MANAGEMENT SYSTEM
// ==========================

// Company Vision & Mission (Annex A)
model CompanyVisionMission {
  id         String   @id @default(cuid())
  vision     String   @db.Text
  mission    String   @db.Text
  coreValues String[] // Array of core values
  objectives String   @db.Text
  isActive   Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Communication Management (Annex C)
model CommunicationLog {
  id             String              @id @default(cuid())
  type           CommunicationType
  crewId         String?
  subject        String
  description    String              @db.Text
  reporter       String // User who reported
  handledBy      String? // User who handled
  status         CommunicationStatus @default(PENDING)
  priority       PriorityLevel       @default(MEDIUM)
  resolution     String?             @db.Text
  resolutionDate DateTime?
  attachments    String[] // File URLs

  crew Crew? @relation(fields: [crewId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum CommunicationType {
  MEDIA_INTERVIEW
  COMPLAINT // MLC Reg 5.1.5
  APPRAISAL_REPORT
  CREW_DISPUTE
  CREW_SICK
  CREW_DEATH
  EMERGENCY
  GENERAL_INQUIRY
}

enum CommunicationStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  ESCALATED
  CLOSED
}

enum PriorityLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Crew Sign-off Management (Annex D)
model CrewSignOff {
  id                  String        @id @default(cuid())
  crewId              String
  assignmentId        String?
  signOffDate         DateTime
  arrivalDate         DateTime?
  passportReceived    Boolean       @default(false)
  seamanBookReceived  Boolean       @default(false)
  debriefingCompleted Boolean       @default(false)
  debriefingNotes     String?       @db.Text
  finalWageAmount     Float?
  wageCalculatedDate  DateTime?
  wagePaidDate        DateTime?
  documentWithdrawn   Boolean       @default(false)
  interviewedBy       String?
  status              SignOffStatus @default(PENDING)

  crew       Crew        @relation(fields: [crewId], references: [id])
  assignment Assignment? @relation(fields: [assignmentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum SignOffStatus {
  PENDING
  DOCUMENTS_RECEIVED
  DEBRIEFING_DONE
  WAGES_CALCULATED
  WAGES_PAID
  COMPLETED
}

// HR Recruitment (Annex E)
model ManpowerRequisition {
  id              String            @id @default(cuid())
  formNumber      String            @unique // HCF-AD-25
  department      String
  position        String
  numberOfVacancy Int
  reason          String            @db.Text
  jobDescription  String            @db.Text
  qualifications  String            @db.Text
  requestedBy     String
  approvedBy      String?
  status          RequisitionStatus @default(PENDING)
  approvalDate    DateTime?
  recruitmentPlan String?           @db.Text
  budget          Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum RequisitionStatus {
  PENDING
  APPROVED
  REJECTED
  IN_PROGRESS
  COMPLETED
}

model PerformanceAppraisal {
  id              String @id @default(cuid())
  formNumber      String @unique // HCF-AD-06
  employeeId      String // Can be shore staff or crew
  employeeName    String
  position        String
  department      String
  appraisalPeriod String // e.g., "Q1 2024", "2024"
  evaluatorId     String
  evaluatorName   String

  // Performance Metrics (1-5 scale)
  qualityOfWork Int // 1-5
  productivity  Int // 1-5
  jobKnowledge  Int // 1-5
  reliability   Int // 1-5
  initiative    Int // 1-5
  teamwork      Int // 1-5
  communication Int // 1-5

  overallScore        Float
  strengths           String                  @db.Text
  areasForImprovement String                  @db.Text
  trainingNeeds       String?                 @db.Text
  goals               String?                 @db.Text
  recommendation      AppraisalRecommendation
  comments            String?                 @db.Text

  employeeSignature  String?
  employeeDate       DateTime?
  evaluatorSignature String?
  evaluatorDate      DateTime?
  hrApproval         String?
  hrApprovalDate     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AppraisalRecommendation {
  EXCELLENT_PROMOTE
  GOOD_MAINTAIN
  SATISFACTORY_DEVELOP
  NEEDS_IMPROVEMENT
  UNSATISFACTORY_ACTION
}

model PurchaseOrder {
  id            String              @id @default(cuid())
  formNumber    String              @unique // HCF-AD-15
  poNumber      String              @unique
  department    String
  requestedBy   String
  supplierId    String?
  supplierName  String
  items         Json // Array of items: [{name, qty, unit, price}]
  totalAmount   Float
  purpose       String              @db.Text
  requestDate   DateTime            @default(now())
  approvedBy    String?
  approvalDate  DateTime?
  status        PurchaseOrderStatus @default(DRAFT)
  paymentStatus PaymentStatus       @default(DRAFT)
  deliveryDate  DateTime?
  receivedBy    String?
  receivedDate  DateTime?
  notes         String?             @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PurchaseOrderStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  ORDERED
  RECEIVED
  CANCELLED
}

// Internal Audit (Procedure 9)
model InternalAudit {
  id            String      @id @default(cuid())
  formNumber    String      @unique // HCF-AD-08
  auditNumber   String      @unique
  auditType     AuditType
  department    String
  auditors      String[] // Array of auditor names
  auditDate     DateTime
  scheduledDate DateTime
  checklist     Json // Audit checklist items
  findings      Json[] // Array of findings
  summary       String      @db.Text
  status        AuditStatus @default(SCHEDULED)

  // Corrective Actions
  correctiveActions String[] // Array of CAPA IDs
  followUpDate      DateTime?
  closureDate       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AuditType {
  INTERNAL_QMS
  EXTERNAL_CERTIFICATION
  SURVEILLANCE
  SPECIAL
}

enum AuditStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  FOLLOW_UP_REQUIRED
  CLOSED
}

// Corrective & Preventive Action (Procedure 10)
model CorrectiveAction {
  id                 String               @id @default(cuid())
  formNumber         String               @unique // HCF-AD-10/11/15
  capaNumber         String               @unique
  type               CAPAType
  source             String // e.g., "Internal Audit", "Customer Complaint"
  department         String
  nonconformity      String               @db.Text
  rootCause          String?              @db.Text
  correctiveAction   String               @db.Text
  preventiveAction   String?              @db.Text
  responsiblePerson  String
  targetDate         DateTime
  implementationDate DateTime?
  verificationMethod String?              @db.Text
  verifiedBy         String?
  verificationDate   DateTime?
  effectiveness      EffectivenessRating?
  status             CAPAStatus           @default(OPEN)
  qmrApproval        String?
  approvalDate       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum CAPAType {
  CORRECTIVE
  PREVENTIVE
  IMPROVEMENT
}

enum CAPAStatus {
  OPEN
  IN_PROGRESS
  PENDING_VERIFICATION
  VERIFIED_EFFECTIVE
  VERIFIED_INEFFECTIVE
  CLOSED
}

enum EffectivenessRating {
  EFFECTIVE
  PARTIALLY_EFFECTIVE
  INEFFECTIVE
}

// Management Review (Section 5.6)
model ManagementReview {
  id            String   @id @default(cuid())
  formNumber    String   @unique // HCF-AD-02
  meetingNumber String   @unique
  meetingDate   DateTime
  attendees     String[] // Array of attendee names
  chairman      String

  // Review Inputs
  auditResults       String  @db.Text
  customerFeedback   String? @db.Text
  processPerformance String  @db.Text
  qualityObjectives  String  @db.Text
  nonconformities    String  @db.Text
  capaStatus         String  @db.Text
  previousActions    String? @db.Text
  risksOpportunities String  @db.Text

  // Review Outputs
  decisions     String  @db.Text
  actionItems   Json[] // Array of action items
  resourceNeeds String? @db.Text
  improvements  String? @db.Text

  minutes        String       @db.Text
  nextReviewDate DateTime?
  status         ReviewStatus @default(SCHEDULED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ReviewStatus {
  SCHEDULED
  COMPLETED
  FOLLOW_UP_PENDING
  CLOSED
}

// QMR Dashboard Tracking
model QMRTask {
  id             String        @id @default(cuid())
  taskType       QMRTaskType
  title          String
  description    String        @db.Text
  priority       PriorityLevel @default(MEDIUM)
  assignedTo     String // QMR user ID
  dueDate        DateTime
  status         TaskStatus    @default(PENDING)
  relatedEntity  String? // ID of related audit/CAPA/review
  completionDate DateTime?
  notes          String?       @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum QMRTaskType {
  AUDIT_PREPARATION
  AUDIT_FOLLOW_UP
  CAPA_VERIFICATION
  DOCUMENT_APPROVAL
  RISK_EVALUATION
  MANAGEMENT_REVIEW
  GENERAL_TASK
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

model HgqsManualVersion {
  id               String                @id @default(cuid())
  docNumber        String
  title            String
  revisionNumber   String
  status           QualityDocumentStatus @default(DRAFT)
  effectiveDate    DateTime?
  fileUrl          String
  summary          String?               @db.Text
  createdById      String
  uploadedByUserId String
  approvedByUserId String?
  workflowId       String?
  notes            String?               @db.Text

  createdBy      User      @relation("ManualCreatedBy", fields: [createdById], references: [id])
  uploadedByUser User      @relation("ManualUploadedBy", fields: [uploadedByUserId], references: [id])
  approvedByUser User?     @relation("ManualApprovedBy", fields: [approvedByUserId], references: [id])
  workflow       Workflow? @relation(fields: [workflowId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([docNumber, revisionNumber])
  @@index([status])
  @@index([createdById])
  @@index([workflowId])
  @@index([effectiveDate])
}

model HgqsProcedure {
  id                String                @id @default(cuid())
  procedureCode     String                @unique
  title             String
  department        String
  controlNumber     String?
  description       String?               @db.Text
  fileUrl           String
  status            QualityDocumentStatus @default(DRAFT)
  tags              String[]
  ownerId           String
  createdById       String
  workflowId        String?
  relatedEntityType String?
  relatedEntityId   String?

  createdBy User      @relation("ProcedureCreatedBy", fields: [createdById], references: [id])
  owner     User      @relation("ProcedureOwner", fields: [ownerId], references: [id])
  workflow  Workflow? @relation(fields: [workflowId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([workflowId])
  @@index([relatedEntityType, relatedEntityId])
}

model HgqsGuideline {
  id                      String                @id @default(cuid())
  slug                    String                @unique
  title                   String
  version                 String
  status                  QualityDocumentStatus @default(DRAFT)
  content                 String                @db.Text
  fileUrl                 String?
  acknowledgementRequired Boolean               @default(true)
  ownerId                 String
  createdById             String
  workflowId              String?

  createdBy        User                        @relation("GuidelineCreatedBy", fields: [createdById], references: [id])
  owner            User                        @relation("GuidelineOwner", fields: [ownerId], references: [id])
  workflow         Workflow?                   @relation(fields: [workflowId], references: [id])
  assignments      HgqsGuidelineAssignment[]
  acknowledgements HgqsPolicyAcknowledgement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([workflowId])
}

model HgqsGuidelineAssignment {
  id               String         @id @default(cuid())
  guidelineId      String
  assignedById     String
  createdById      String
  assignedToUserId String?
  assignedToRole   Role?
  dueDate          DateTime?
  note             String?        @db.Text
  status           WorkflowStatus @default(SUBMITTED)

  guideline        HgqsGuideline               @relation(fields: [guidelineId], references: [id])
  assignedBy       User                        @relation("GuidelineAssignedBy", fields: [assignedById], references: [id])
  createdBy        User                        @relation("GuidelineAssignmentCreatedBy", fields: [createdById], references: [id])
  assignedToUser   User?                       @relation("GuidelineAssignedToUser", fields: [assignedToUserId], references: [id])
  acknowledgements HgqsPolicyAcknowledgement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([guidelineId])
  @@index([assignedToRole])
  @@index([assignedToUserId])
  @@index([status])
  @@index([createdById])
}

model HgqsPolicyAcknowledgement {
  id               String                @id @default(cuid())
  guidelineId      String
  assigneeId       String
  assignmentId     String?
  status           AcknowledgementStatus @default(PENDING)
  acknowledgedAt   DateTime?
  acknowledgedById String?
  signature        String?
  notes            String?               @db.Text
  createdById      String
  workflowId       String?

  guideline      HgqsGuideline            @relation(fields: [guidelineId], references: [id])
  assignee       User                     @relation("GuidelineAcknowledgementAssignee", fields: [assigneeId], references: [id])
  assignment     HgqsGuidelineAssignment? @relation(fields: [assignmentId], references: [id])
  createdBy      User                     @relation("GuidelineAcknowledgementCreatedBy", fields: [createdById], references: [id])
  acknowledgedBy User?                    @relation("GuidelineAcknowledgedBy", fields: [acknowledgedById], references: [id])
  workflow       Workflow?                @relation(fields: [workflowId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([guidelineId, assigneeId])
  @@index([assignmentId])
  @@index([status])
  @@index([createdById])
  @@index([workflowId])
}

model HgqsAttendanceLog {
  id             String           @id @default(cuid())
  employeeId     String
  attendanceDate DateTime
  status         AttendanceStatus @default(PRESENT)
  clockIn        DateTime?
  clockOut       DateTime?
  notes          String?          @db.Text
  createdById    String
  recordedById   String

  employee   User @relation("AttendanceEmployee", fields: [employeeId], references: [id])
  createdBy  User @relation("AttendanceCreatedBy", fields: [createdById], references: [id])
  recordedBy User @relation("AttendanceRecordedBy", fields: [recordedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, attendanceDate])
  @@index([status])
  @@index([createdById])
  @@index([recordedById])
}

model HgqsLeaveRequest {
  id              String      @id @default(cuid())
  employeeId      String
  leaveType       LeaveType
  startDate       DateTime
  endDate         DateTime
  reason          String      @db.Text
  status          LeaveStatus @default(DRAFT)
  submittedById   String
  createdById     String
  reviewedById    String?
  approvedById    String?
  rejectionReason String?     @db.Text
  workflowId      String?

  employee    User      @relation("LeaveEmployee", fields: [employeeId], references: [id])
  submittedBy User      @relation("LeaveSubmittedBy", fields: [submittedById], references: [id])
  createdBy   User      @relation("LeaveCreatedBy", fields: [createdById], references: [id])
  reviewedBy  User?     @relation("LeaveReviewedBy", fields: [reviewedById], references: [id])
  approvedBy  User?     @relation("LeaveApprovedBy", fields: [approvedById], references: [id])
  workflow    Workflow? @relation(fields: [workflowId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([createdById])
  @@index([workflowId])
}

model HgqsDisciplinaryCase {
  id                String                 @id @default(cuid())
  caseNumber        String                 @unique
  reportedById      String
  reportedAgainstId String
  incidentDate      DateTime
  incidentSummary   String                 @db.Text
  severity          DisciplinarySeverity   @default(LOW)
  status            DisciplinaryCaseStatus @default(OPEN)
  isConfidential    Boolean                @default(false)
  visibleToRoles    Role[]
  attachments       String[]
  resolution        String?                @db.Text
  closedById        String?
  closedAt          DateTime?
  createdById       String
  workflowId        String?

  reportedBy      User      @relation("DisciplinaryReportedBy", fields: [reportedById], references: [id])
  reportedAgainst User      @relation("DisciplinaryReportedAgainst", fields: [reportedAgainstId], references: [id])
  createdBy       User      @relation("DisciplinaryCreatedBy", fields: [createdById], references: [id])
  closedBy        User?     @relation("DisciplinaryClosedBy", fields: [closedById], references: [id])
  workflow        Workflow? @relation(fields: [workflowId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdById])
  @@index([workflowId])
  @@index([reportedAgainstId])
}

// ============================================================================
// PHASE 1: RISK & AUDIT MANAGEMENT MODELS
// ============================================================================
// ISO 9001:2015 Clause 6.1 (Risk Management)
// ISO 9001:2015 Clause 9.2 (Internal Audit)
// MLC 2006 Regulation 1.4 (Seafarer Placement)
// ============================================================================

// Risk source classification
enum RiskSource {
  REGULATORY // Government / maritime regulations (SOLAS, STCW, MLC)
  OPERATIONAL // Internal processes, crew management, procedures
  STRATEGIC // Business continuity, market shifts, competition
  FINANCIAL // Budget, cash flow, currency, insurance
  ENVIRONMENTAL // Weather, seas, pollution, climate
}

// Risk mitigation strategy selection
enum RiskTreatmentStrategy {
  MITIGATE // Reduce probability or impact through controls
  ACCEPT // Accept the risk, monitor and review
  TRANSFER // Insurance, outsource, or delegate
  AVOID // Don't do the activity, eliminate the risk
}

// Audit finding severity levels
enum FindingSeverity {
  OBSERVATION // Good practice note, no nonconformance
  MINOR_NC // Minor nonconformance (one system not working)
  MAJOR_NC // Major nonconformance (system ineffective)
}

// ============================================================================
// Risk Management Models (ISO 9001 Clause 6.1)
// ============================================================================

model Risk {
  id          String     @id @default(cuid())
  title       String // e.g., "Key Personnel Dependency"
  description String     @db.Text
  source      RiskSource // REGULATORY, OPERATIONAL, STRATEGIC, FINANCIAL, ENVIRONMENTAL

  // Risk Assessment (ISO 9001:2015 Clause 6.1.1)
  probability Int // 1-5 scale (1=very unlikely, 5=almost certain)
  impact      Int // 1-5 scale (1=negligible, 5=catastrophic)
  riskScore   Int // probability  impact (computed, 1-25)

  // Risk Treatment (ISO 9001:2015 Clause 6.1.2)
  treatmentStrategy RiskTreatmentStrategy // MITIGATE, ACCEPT, TRANSFER, AVOID
  treatmentPlan     String                @db.Text

  // Status & Lifecycle
  status     String    @default("ACTIVE") // ACTIVE, MITIGATED, TRANSFERRED, ACCEPTED, CLOSED
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  reviewedAt DateTime?

  // Relations (Additive - no existing models affected)
  actions  RiskAction[]
  reviews  RiskReview[]
  auditLog RiskAuditLog[]

  // Metadata
  createdById String // User ID
  createdBy   User   @relation("RiskCreatedBy", fields: [createdById], references: [id])

  @@index([source])
  @@index([status])
  @@index([riskScore])
  @@index([createdById])
  @@index([createdAt])
}

// Risk Mitigation Actions (ISO 9001:2015 Clause 6.1.2)
model RiskAction {
  id     String @id @default(cuid())
  riskId String
  risk   Risk   @relation(fields: [riskId], references: [id], onDelete: Cascade)

  description String @db.Text
  owner       String // User ID
  ownedBy     User   @relation("RiskActionOwner", fields: [owner], references: [id])

  dueDate     DateTime
  completedAt DateTime?
  status      String    @default("OPEN") // OPEN, COMPLETED, OVERDUE, CANCELLED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([riskId])
  @@index([status])
  @@index([dueDate])
  @@index([owner])
}

// Risk Effectiveness Review (ISO 9001:2015 Clause 6.1.3)
model RiskReview {
  id     String @id @default(cuid())
  riskId String
  risk   Risk   @relation(fields: [riskId], references: [id], onDelete: Cascade)

  reviewDate     DateTime @default(now())
  newProbability Int? // 1-5 scale (updated after mitigation)
  newImpact      Int? // 1-5 scale (updated after mitigation)
  newRiskScore   Int? // probability  impact (recalculated)
  effectiveness  Int // 1-5 (1=ineffective, 5=fully effective)
  notes          String   @db.Text

  reviewedById String // User ID
  reviewedBy   User   @relation("RiskReviewedBy", fields: [reviewedById], references: [id])

  @@index([riskId])
  @@index([reviewDate])
  @@index([reviewedById])
}

// Risk Audit Log (ISO 9001:2015 Clause 8.5.2 - Immutable Record)
model RiskAuditLog {
  id     String @id @default(cuid())
  riskId String
  risk   Risk   @relation(fields: [riskId], references: [id], onDelete: Cascade)

  action        String // "CREATED", "UPDATED", "REVIEWED", "LINKED_NONCONFORMANCE", etc.
  changedFields Json // Immutable JSON record of what changed
  changedById   String // User ID
  changedBy     User     @relation("RiskAuditLogBy", fields: [changedById], references: [id])
  changedAt     DateTime @default(now())

  @@index([riskId])
  @@index([changedAt])
  @@index([action])
  @@index([changedById])
}

// ============================================================================
// Internal Audit Models (ISO 9001 Clause 9.2, MLC 2006 Reg 1.4)
// ============================================================================

// Audit Schedule & Planning
model AuditSchedule {
  id          String @id @default(cuid())
  title       String
  description String @db.Text

  auditType AuditType // INTERNAL, MANAGEMENT_REVIEW, SURVEILLANCE
  frequency String // "QUARTERLY", "SEMI-ANNUAL", "ANNUAL", "ON_DEMAND"

  startDate DateTime
  endDate   DateTime?

  // JSON arrays of user IDs (auditors and auditees)
  auditees String[] // User IDs (crew to be audited)
  auditors String[] // User IDs (who conducts audit)

  status String @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  findings AuditFinding[]
  report   AuditReport?

  @@index([auditType])
  @@index([status])
  @@index([startDate])
}

// Audit Checklist Template (Reusable across audits)
model AuditChecklist {
  id    String @id @default(cuid())
  title String

  // ISO 9001 & MLC 2006 clause references
  clauses String[] // e.g., ["6.1", "9.2", "1.4"]

  // Checklist items as JSON (immutable template)
  checkpoints Json // Array of {id, clause, question, scoring}

  status  String @default("ACTIVE") // ACTIVE, ARCHIVED, DRAFT, DEPRECATED
  version String @default("1.0")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([version])
}

// Individual Audit Finding
model AuditFinding {
  id         String        @id @default(cuid())
  scheduleId String
  schedule   AuditSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  findingNumber String // AUTO: AUD-2025-001 format
  clause        String // ISO 9001 or MLC reference, e.g., "6.1", "1.4"
  description   String @db.Text

  severity FindingSeverity // OBSERVATION, MINOR_NC, MAJOR_NC
  evidence String[] // Notes, findings, supporting documentation

  status     String    @default("OPEN") // OPEN, RESOLVED, CLOSED, SUPERSEDED
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?

  @@unique([scheduleId, findingNumber])
  @@index([scheduleId])
  @@index([severity])
  @@index([status])
}

// Audit Report (Aggregated findings & recommendations)
model AuditReport {
  id         String        @id @default(cuid())
  scheduleId String        @unique
  schedule   AuditSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  reportNumber String   @unique // AUTO: AUD-RPT-2025-001
  reportDate   DateTime @default(now())

  summary         String @db.Text
  findings        Json // Aggregated: {total, observations, minorNC, majorNC}
  recommendations String @db.Text

  approvedById String? // QMR User ID
  approvedBy   User?     @relation("AuditReportApprovedBy", fields: [approvedById], references: [id])
  approvedAt   DateTime?

  status String @default("DRAFT") // DRAFT, FINALIZED, APPROVED

  @@index([scheduleId])
  @@index([status])
  @@index([reportDate])
}

// ==========================
// CREWING PROCEDURES & COMPLIANCE (Phase 1: Digitize)
// ==========================

model CrewingProcedure {
  id          String  @id @default(cuid())
  procId      String  @unique // PROC-CR-001, etc
  code        String  @unique // HGF-CR-01, etc
  title       String
  department  String  @default("Crewing")
  phase       String  // Recruitment, Pre-Deployment, Deployment, Post-Deployment
  description String  @db.Text
  
  // Structured procedure data
  stepsJson   Json    // Array of {order, title, description, required, ...}
  responsibilities String[] // Array of responsible roles
  timeline    String
  formCode    String  // Reference to HGF form
  
  // Compliance
  complianceStandards String[] // ISO 9001:2015, MLC 2006, etc
  isActive    Boolean @default(true)
  version     Int     @default(1)
  
  // Audit trail
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedById String?
  updatedBy   User?    @relation("CrewingProcedureUpdatedBy", fields: [updatedById], references: [id])
  
  // Relations
  checklists  CrewingChecklist[]
  
  @@index([phase])
  @@index([procId])
  @@index([isActive])
}

enum CrewingChecklistStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  PENDING_REVIEW
  APPROVED
  REJECTED
}

model CrewingChecklist {
  id              String                    @id @default(cuid())
  procedureId     String
  procedure       CrewingProcedure          @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  
  // Context
  applicationId   String?
  application     Application?             @relation(fields: [applicationId], references: [id], onDelete: SetNull)
  crewId          String?
  crew            Crew?                    @relation(fields: [crewId], references: [id], onDelete: SetNull)
  
  // Checklist tracking
  checklistCode   String // HGF-CR-01-001, etc
  status          CrewingChecklistStatus   @default(NOT_STARTED)
  
  // Items completion
  itemsJson       Json // Array of {order, title, checked, completedAt, completedBy}
  completionPercent Int @default(0)
  
  // Approvals
  submittedAt     DateTime?
  submittedById   String?
  submittedBy     User?                    @relation("ChecklistSubmittedBy", fields: [submittedById], references: [id])
  
  approvedAt      DateTime?
  approvedById    String?
  approvedBy      User?                    @relation("ChecklistApprovedBy", fields: [approvedById], references: [id])
  
  remarks         String? @db.Text
  
  // Audit trail
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([procedureId, applicationId, crewId])
  @@index([status])
  @@index([procedureId])
  @@index([applicationId])
  @@index([crewId])
}

model CrewingDocumentRequirement {
  id              String @id @default(cuid())
  procedureId     String
  
  // Document requirement
  documentCode    String // SIRB, PASSPORT, STCW, MEDICAL, etc
  documentTitle   String
  description     String? @db.Text
  
  // Validation rules
  isRequired      Boolean @default(true)
  minValidity     Int? // Months
  acceptableIssuingCountries String[] // Empty = all accepted
  
  // Audit trail
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([procedureId, documentCode])
  @@index([procedureId])
}
// ==========================
// PHASE 2: HGF FORMS & DOCUMENTS
// ==========================

enum HGFFormType {
  CHECKLIST
  APPLICATION
  VERIFICATION
  TRAINING
  DECLARATION
}

enum HGFSubmissionStatus {
  DRAFT
  SUBMITTED
  PENDING_REVIEW
  UNDER_REVIEW
  REVISIONS_NEEDED
  RESUBMITTED
  APPROVED
  REJECTED
  ARCHIVED
}

enum DocumentVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

model HGFForm {
  id              String          @id @default(cuid())
  formCode        String          @unique // HGF-CR-01, HGF-CR-02, etc
  procedureId     String?
  
  // Form metadata
  name            String
  description     String?         @db.Text
  formType        HGFFormType
  
  // Form structure (JSON with field definitions)
  fieldsJson      Json // Array of {id, name, label, type, required, ...}
  sectionsJson    Json? // Array of {id, title, description, fieldIds}
  
  // Validation rules
  validationJson  Json? // Array of {fieldName, ruleType, ruleValue, errorMessage}
  
  // Document requirements
  requiredDocs    Json? // Array of {code, title, required, expiryMonths}
  
  // Status & versioning
  isActive        Boolean         @default(true)
  version         Int             @default(1)
  
  // Audit trail
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  submissions     HGFSubmission[]
  validationRules FormValidationRule[]
  
  @@index([formCode])
  @@index([formType])
  @@index([isActive])
}

model HGFSubmission {
  id              String                @id @default(cuid())
  formId          String
  form            HGFForm               @relation(fields: [formId], references: [id])
  
  // Reference information
  formCode        String // Denormalized for faster lookup
  crewId          String?
  crew            Crew?                 @relation(fields: [crewId], references: [id])
  applicationId   String?
  application     Application?          @relation("HGFSubmission", fields: [applicationId], references: [id])
  
  // Form response data
  submittedData   Json // Form field values
  
  // Status & workflow
  status          HGFSubmissionStatus   @default(DRAFT)
  
  // Submission tracking
  submittedAt     DateTime?
  submittedById   String?
  submittedBy     User?                 @relation("HGFSubmissionSubmittedBy", fields: [submittedById], references: [id])
  
  // Approval workflow
  approvalStep    Int                   @default(0) // Which step in approval chain
  approvedAt      DateTime?
  approvedById    String?
  approvedBy      User?                 @relation("HGFSubmissionApprovedBy", fields: [approvedById], references: [id])
  
  rejectedAt      DateTime?
  rejectedById    String?
  rejectedBy      User?                 @relation("HGFSubmissionRejectedBy", fields: [rejectedById], references: [id])
  rejectionReason String?               @db.Text
  
  // Revision tracking
  revisionReason  String?               @db.Text
  revisionsAskedAt DateTime?
  revisionsAskedById String?
  revisionsAskedBy User?                @relation("HGFSubmissionRevisionsAskedBy", fields: [revisionsAskedById], references: [id])
  
  // Remarks & comments
  remarks         String?               @db.Text
  approvalRemarks String?               @db.Text
  
  // Document verification
  allDocsVerified Boolean               @default(false)
  
  // Audit trail
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  
  documents       DocumentUpload[]
  auditLog        HGFSubmissionAuditLog[]
  
  @@unique([formId, crewId, applicationId])
  @@index([formCode])
  @@index([status])
  @@index([crewId])
  @@index([applicationId])
  @@index([submittedAt])
}

// Add to Application model relation
// hgfSubmissions HGFSubmission[] @relation("HGFSubmission")

model DocumentUpload {
  id              String                    @id @default(cuid())
  submissionId    String
  submission      HGFSubmission             @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  
  crewId          String?
  crew            Crew?                     @relation(fields: [crewId], references: [id])
  
  // Document information
  documentType    String // CERTIFICATE, PASSPORT, MEDICAL, VISA, etc
  documentCode    String? // STCW_BST, PASSPORT, etc
  documentTitle   String?
  
  // File information
  fileName        String
  fileUrl         String // S3 or storage path
  fileSize        Int // Bytes
  mimeType        String // application/pdf, image/jpeg, etc
  
  // Document metadata
  issueDate       DateTime?
  expiryDate      DateTime?
  documentNumber  String? // Passport number, certificate number, etc
  issuingCountry  String?
  
  // Verification
  verificationStatus DocumentVerificationStatus @default(PENDING)
  verifiedAt      DateTime?
  verifiedById    String?
  verifiedBy      User?                     @relation("DocumentUploadVerifiedBy", fields: [verifiedById], references: [id])
  verificationNotes String?                 @db.Text
  
  // Audit trail
  uploadedAt      DateTime                  @default(now())
  uploadedById    String?
  uploadedBy      User?                     @relation("DocumentUploadUploadedBy", fields: [uploadedById], references: [id])
  
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  
  @@index([submissionId])
  @@index([crewId])
  @@index([documentCode])
  @@index([verificationStatus])
}

model FormValidationRule {
  id              String          @id @default(cuid())
  formId          String
  form            HGFForm         @relation(fields: [formId], references: [id], onDelete: Cascade)
  
  // Rule definition
  fieldName       String
  ruleType        String // REQUIRED, PATTERN, MIN_LENGTH, MAX_LENGTH, CUSTOM
  ruleValue       String? // Regex, number, or custom rule name
  
  // Validation message
  errorMessage    String
  
  // Dependency (conditional validation)
  dependsOnField  String? // Only validate if another field has value
  dependsOnValue  String? // Only validate if that field equals this
  
  // Order for processing
  orderIndex      Int             @default(0)
  
  // Audit trail
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@unique([formId, fieldName, ruleType])
  @@index([formId])
  @@index([fieldName])
}

model FormTemplate {
  id              String          @id @default(cuid())
  
  // Template metadata
  name            String          @unique
  description     String?         @db.Text
  formType        HGFFormType
  category        String? // e.g., "Crewing", "Medical", "Training"
  
  // Base field definitions
  baseFieldsJson  Json // Template field definitions
  
  // Usage tracking
  usageCount      Int             @default(0)
  lastUsedAt      DateTime?
  
  // Status
  isActive        Boolean         @default(true)
  
  // Audit trail
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  createdById     String
  createdBy       User            @relation("FormTemplateCreatedBy", fields: [createdById], references: [id])
  
  @@index([formType])
  @@index([isActive])
}

// Add relation to User model:
// formTemplatesCreated FormTemplate[] @relation("FormTemplateCreatedBy")

model HGFSubmissionAuditLog {
  id              String          @id @default(cuid())
  submissionId    String
  submission      HGFSubmission   @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  
  // Action information
  action          String // CREATE, UPDATE, SUBMIT, APPROVE, REJECT, VERIFY_DOC, etc
  changedFields   Json? // {fieldName: {from, to}}
  
  // Actor information
  performedById   String
  performedBy     User            @relation(fields: [performedById], references: [id])
  
  // Request context
  ipAddress       String?
  userAgent       String?
  reason          String?         @db.Text
  
  // Timestamp
  performedAt     DateTime        @default(now())
  
  @@index([submissionId])
  @@index([action])
  @@index([performedAt])
}

// Add relation to User model:
// hgfSubmissionAuditLogs HGFSubmissionAuditLog[]

model EmailNotificationLog {
  id              String          @id @default(cuid())
  
  // Email details
  recipientEmail  String
  recipientName   String?
  subject         String
  emailType       String // SUBMISSION_CONFIRMATION, APPROVAL_REQUIRED, etc
  
  // Related entity
  relatedEntityType String? // HGFSubmission, DocumentUpload, etc
  relatedEntityId String?
  
  // Status
  status          String          @default("SENT") // SENT, FAILED, BOUNCED
  failureReason   String?
  
  // Audit
  sentAt          DateTime        @default(now())
  
  @@index([recipientEmail])
  @@index([emailType])
  @@index([status])
}
// Add to Application model (relation)
// checklists CrewingChecklist[]

// Add to Crew model (relation)
// checklists CrewingChecklist[]

// ============================================================================
// MODULE: QUALITY MANAGEMENT SYSTEM (QMS) DASHBOARD - PHASE 3
// ============================================================================

enum DocumentStatus {
  ACTIVE
  EXPIRED
  EXPIRING_SOON
  ARCHIVED
}

enum NonconformityStatus {
  OPEN
  UNDER_REVIEW
  IN_PROGRESS
  CLOSED
  REJECTED
}

enum AuditCategoryType {
  DOCUMENT_VERIFICATION
  PROCESS_COMPLIANCE
  CREW_RECORD
  TRAINING_REQUIREMENT
  SAFETY_PROTOCOL
  REGULATORY
}

model QMSDocument {
  id              String          @id @default(cuid())
  
  // Document reference
  crewId          String?
  crew            Crew?           @relation(fields: [crewId], references: [id])
  documentId      String?
  document        CrewDocument?   @relation(fields: [documentId], references: [id])
  
  // QMS tracking
  status          DocumentStatus  @default(ACTIVE)
  riskLevel       String          // LOW, MEDIUM, HIGH, CRITICAL
  lastVerifiedAt  DateTime?
  expiresAt       DateTime?
  
  // Metadata
  category        String          // CERTIFICATE, MEDICAL, VISA, etc
  reviewedBy      String?
  reviewer        User?           @relation("QMSDocumentReviewedBy", fields: [reviewedBy], references: [id])
  remarks         String?         @db.Text
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([crewId])
  @@index([status])
  @@index([riskLevel])
  @@index([expiresAt])
}

model NonconformityRecord {
  id              String          @id @default(cuid())
  
  // Reference
  crewId          String?
  crew            Crew?           @relation(fields: [crewId], references: [id])
  
  // Details
  type            String          // FAKE_CERT, MISSING_DOC, EXPIRED_CERT, etc
  severity        String          // LOW, MEDIUM, HIGH, CRITICAL
  status          NonconformityStatus @default(OPEN)
  
  // Description
  description     String          @db.Text
  findings        String?         @db.Text
  correctiveAction String?        @db.Text
  
  // Timeline
  reportedAt      DateTime        @default(now())
  dueDate         DateTime?
  closedAt        DateTime?
  
  // Assignment
  assignedTo      String?
  assignee        User?           @relation("NonconformityAssignedTo", fields: [assignedTo], references: [id])
  
  // Verification
  verifiedBy      String?
  verifier        User?           @relation("NonconformityVerifier", fields: [verifiedBy], references: [id])
  verificationDate DateTime?
  
  // Audit trail
  auditLogs       NonconformityAuditLog[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([crewId])
  @@index([status])
  @@index([severity])
  @@index([dueDate])
}

model NonconformityAuditLog {
  id              String          @id @default(cuid())
  
  // Reference
  nonconformityId String
  nonconformity   NonconformityRecord @relation(fields: [nonconformityId], references: [id], onDelete: Cascade)
  
  // Action
  action          String          // CREATED, STATUS_CHANGED, COMMENT_ADDED, etc
  oldValue        String?
  newValue        String?
  comment         String?         @db.Text
  
  // Actor
  performedBy     String
  user            User            @relation("NonconformityAuditLogBy", fields: [performedBy], references: [id])
  
  createdAt       DateTime        @default(now())
  
  @@index([nonconformityId])
  @@index([action])
  @@index([performedBy])
}

model AuditTrail {
  id              String          @id @default(cuid())
  
  // Audit details
  category        AuditCategoryType
  entityType      String          // Crew, Document, HGFSubmission, etc
  entityId        String?
  
  // Event
  event           String          // CREATED, UPDATED, DELETED, VERIFIED, REJECTED, etc
  description     String?         @db.Text
  changesSummary  String?         @db.Text // JSON string of changes
  
  // Context
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  ipAddress       String?
  userAgent       String?
  
  // Status
  severity        String          @default("INFO") // INFO, WARNING, CRITICAL
  
  createdAt       DateTime        @default(now())
  
  @@index([entityType])
  @@index([category])
  @@index([severity])
  @@index([createdAt])
  @@index([userId])
}

model ComplianceMetric {
  id              String          @id @default(cuid())
  
  // Metric definition
  name            String          @unique
  description     String?
  
  // Current value
  currentValue    Float
  targetValue     Float
  unit            String          // PERCENT, COUNT, DAYS, etc
  
  // Calculation
  formula         String?         @db.Text // For calculated metrics
  lastCalculatedAt DateTime       @default(now())
  
  // Trend
  trend           String?         // UP, DOWN, STABLE
  trendDate       DateTime?
  
  // Metadata
  isActive        Boolean         @default(true)
  category        String          // DOCUMENT_COMPLIANCE, TRAINING_COMPLIANCE, etc
  
  // Relations
  history         ComplianceMetricHistory[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([category])
  @@index([isActive])
}

model ComplianceMetricHistory {
  id              String          @id @default(cuid())
  
  // Reference
  metricId        String
  metric          ComplianceMetric @relation(fields: [metricId], references: [id], onDelete: Cascade)
  
  // Value
  value           Float
  calculatedAt    DateTime        @default(now())
  
  @@index([metricId])
  @@index([calculatedAt])
}

model QMSReport {
  id              String          @id @default(cuid())
  
  // Report details
  title           String
  description     String?         @db.Text
  reportType      String          // MONTHLY, QUARTERLY, ANNUAL, AUDIT, etc
  
  // Period
  periodStart     DateTime
  periodEnd       DateTime
  
  // Content (as JSON for flexibility)
  sections        String          @db.Text // JSON array of report sections
  
  // Status
  status          String          @default("DRAFT") // DRAFT, FINAL, APPROVED, PUBLISHED
  approvedBy      String?
  approver        User?           @relation("QMSReportApprovedBy", fields: [approvedBy], references: [id])
  approvedAt      DateTime?
  
  // Metrics snapshot
  metricsSnapshot String?         @db.Text // JSON snapshot of metrics at report time
  
  // File
  fileUrl         String?
  fileName        String?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([reportType])
  @@index([status])
  @@index([periodStart])
  @@index([approvedBy])
}

// ============================================================================
// DOCUMENT CONTROL SYSTEM
// ============================================================================

model DocumentControl {
  id              String          @id @default(cuid())
  
  // Document identification (HGQS-MM, HGQS-PM, HGQS-MG, etc)
  code            String          @unique // HGQS-MM-001, HGQS-PM-002, etc
  title           String
  description     String?         @db.Text
  
  // Document type (Manual, Procedure, Form, etc)
  documentType    String          // MAIN_MANUAL, PROCEDURE, FORM, GUIDELINE, WORK_INSTRUCTION
  department      String          // HGQS, CREWING, ACCOUNTING, HR, ADMIN, QUALITY, etc
  
  // Current version
  currentRevision Int             @default(0)
  status          DocumentControlStatus @default(DRAFT)
  
  // Retention
  retentionPeriod RetentionPeriod @default(PERMANENT)
  retentionStartDate DateTime?
  disposalDate    DateTime?
  
  // Content & attachments
  contentUrl      String?         // S3 URL or file path
  fileName        String?
  fileSize        Int?            // bytes
  
  // Metadata
  effectiveDate   DateTime
  obsoleteDate    DateTime?
  
  // Relations
  createdById     String
  createdBy       User            @relation("DocumentCreatedBy", fields: [createdById], references: [id])
  
  revisions       DocumentRevision[]
  approvals       DocumentApproval[]
  distributions   DocumentDistribution[]
  acknowledgements DocumentAcknowledgement[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([code])
  @@index([status])
  @@index([department])
  @@index([documentType])
  @@index([createdById])
}

model DocumentRevision {
  id              String          @id @default(cuid())
  
  // Reference to main document
  documentId      String
  document        DocumentControl @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Revision info
  revisionNumber  Int             // v1, v2, v3, etc
  changesSummary  String?         @db.Text // What changed in this revision
  
  // File
  revisionUrl     String?
  fileName        String?
  
  // Creator
  createdById     String
  createdBy       User            @relation("DocumentRevisionCreatedBy", fields: [createdById], references: [id])
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([documentId])
  @@index([revisionNumber])
  @@index([createdById])
  @@unique([documentId, revisionNumber])
}

model DocumentApproval {
  id              String          @id @default(cuid())
  
  // Reference to document
  documentId      String
  document        DocumentControl @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Approval flow
  approvalLevel   Int             // 1 = QMR, 2 = Director, etc
  approvalRole    String          // QMR, DIRECTOR, SECTION_HEAD, etc
  
  status          ApprovalStatus  @default(PENDING)
  
  // Approver info
  assignedToId    String?
  assignedTo      User?           @relation("DocumentApprovalAssignedTo", fields: [assignedToId], references: [id])
  
  approvedById    String?
  approvedBy      User?           @relation("DocumentApprovalApprovedBy", fields: [approvedById], references: [id])
  
  approvalComments String?        @db.Text
  approvedAt      DateTime?
  rejectionReason String?         @db.Text
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([documentId])
  @@index([status])
  @@index([assignedToId])
  @@index([approvedById])
}

model DocumentDistribution {
  id              String          @id @default(cuid())
  
  // Reference to document
  documentId      String
  document        DocumentControl @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Distributed to
  recipientId     String
  recipient       User            @relation("DocumentDistributionRecipient", fields: [recipientId], references: [id])
  
  // Distribution details
  distributionType String         // EMAIL, SYSTEM_NOTIFICATION, MANUAL, etc
  distributedAt   DateTime        @default(now())
  
  // Acknowledgement required?
  requiresAcknowledgement Boolean @default(true)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([documentId])
  @@index([recipientId])
  @@unique([documentId, recipientId])
}

model DocumentAcknowledgement {
  id              String          @id @default(cuid())
  
  // Reference to document
  documentId      String
  document        DocumentControl @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Acknowledgement by
  acknowledgedById String
  acknowledgedBy  User            @relation("DocumentAcknowledgement", fields: [acknowledgedById], references: [id])
  
  status          AcknowledgementStatus @default(PENDING)
  acknowledgedAt  DateTime?
  
  // Comments
  remarks         String?         @db.Text
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([documentId])
  @@index([acknowledgedById])
  @@index([status])
  @@unique([documentId, acknowledgedById])
}

// ============================================================================
// POINT 4.3 - AUDIT & NONCONFORMITY MODELS
// ============================================================================

model ComplianceAudit {
  id                    String                   @id @default(cuid())
  auditNumber           String                   @unique
  auditDate             DateTime
  status                ComplianceAuditStatus
  auditType             String
  scope                 String?
  objectives            String?
  auditCriteria         String?
  leadAuditorId         String
  assistantAuditors     String?
  auditeeContactPerson  String?
  auditeeContactEmail   String?
  auditeeContactPhone   String?
  estimatedDuration     Int?
  startDate             DateTime?
  endDate               DateTime?
  location              String?
  findings              Int?
  nonConformities       Int?
  observations          Int?
  remarks               String?
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  deletedAt             DateTime?
  
  // Relations
  leadAuditor           User                     @relation("AuditLeadAuditor", fields: [leadAuditorId], references: [id])
  findingsList          ComplianceAuditFinding[]
  nonConformityList     NonConformity[]
  
  @@index([auditType])
  @@index([status])
  @@index([leadAuditorId])
}

model ComplianceAuditFinding {
  id              String          @id @default(cuid())
  
  // Reference to audit
  auditId         String
  audit           ComplianceAudit @relation(fields: [auditId], references: [id], onDelete: Cascade)
  
  // Finding details
  findingCode     String
  description     String          @db.Text
  severity        NCFindingSeverity @default(MINOR)
  
  // Related document/process
  relatedDocId    String?
  relatedProcess  String?
  
  // Assignment
  assignedToId    String?
  assignedTo      User?           @relation("AuditFindingAssignedTo", fields: [assignedToId], references: [id])
  
  dueDate         DateTime?
  closedDate      DateTime?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([auditId])
  @@index([severity])
}

model NonConformity {
  id              String          @id @default(cuid())
  
  // Reference
  ncNumber        String          @unique
  auditId         String
  audit           ComplianceAudit @relation(fields: [auditId], references: [id], onDelete: Cascade)
  
  // Details
  description     String          @db.Text
  rootCause       String?         @db.Text
  status          NonConformityStatus @default(OPEN)
  
  // Assignment
  assignedToId    String
  assignedTo      User            @relation("NonConformityAssignedTo", fields: [assignedToId], references: [id])
  
  // Tracking
  identifiedDate  DateTime        @default(now())
  targetDate      DateTime
  resolvedDate    DateTime?
  verifiedDate    DateTime?
  verifiedById    String?
  verifiedBy      User?           @relation("NonConformityVerifiedBy", fields: [verifiedById], references: [id])
  
  // Corrective actions
  correctiveActions NCCorrectiveAction[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([auditId])
  @@index([status])
  @@index([assignedToId])
}

model NCCorrectiveAction {
  id              String          @id @default(cuid())
  
  // Reference
  caNumber        String          @unique
  nonConformityId String
  nonConformity   NonConformity   @relation(fields: [nonConformityId], references: [id], onDelete: Cascade)
  
  // Details
  action          String          @db.Text
  status          NCCorrectiveActionStatus @default(PENDING)
  
  // Assignment
  assignedToId    String
  assignedTo      User            @relation("CorrectiveActionAssignedTo", fields: [assignedToId], references: [id])
  
  // Tracking
  dueDate         DateTime
  completedDate   DateTime?
  verifiedDate    DateTime?
  verifiedById    String?
  verifiedBy      User?           @relation("CorrectiveActionVerifiedBy", fields: [verifiedById], references: [id])
  
  // Evidence/Documents
  evidenceDoc     String?         // Document URL or file path
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([nonConformityId])
  @@index([status])
  @@index([assignedToId])
}

// ============================================================================
// POINT 4.4 - HR COMPLIANCE MODELS
// ============================================================================

model HRTraining {
  id              String          @id @default(cuid())
  
  // Training details
  trainingCode    String          @unique
  title           String
  description     String?         @db.Text
  trainingType    TrainingType
  
  // Schedule
  startDate       DateTime
  endDate         DateTime
  duration        Int             // Hours
  
  // Provider
  provider        String
  location        String?
  
  // Tracking
  employeeTrainings EmployeeTraining[]
  
  isActive        Boolean         @default(true)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([trainingType])
  @@index([isActive])
}

model EmployeeTraining {
  id              String          @id @default(cuid())
  
  // Reference
  employeeId      String
  employee        User            @relation("EmployeeTraining", fields: [employeeId], references: [id], onDelete: Cascade)
  
  trainingId      String
  training        HRTraining      @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  
  // Tracking
  status          TrainingStatus  @default(NOT_STARTED)
  enrolledDate    DateTime        @default(now())
  completedDate   DateTime?
  expiryDate      DateTime?
  
  // Results
  score           Float?
  certificateUrl  String?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@unique([employeeId, trainingId])
  @@index([employeeId])
  @@index([trainingId])
  @@index([status])
}

model Certification {
  id              String          @id @default(cuid())
  
  // Reference
  employeeId      String
  employee        User            @relation("EmployeeCertification", fields: [employeeId], references: [id], onDelete: Cascade)
  
  // Details
  certCode        String
  title           String
  certType        CertificationType
  issuer          String
  
  // Tracking
  issuedDate      DateTime
  expiryDate      DateTime?
  status          CertificationStatus @default(ACTIVE)
  
  // Document
  certificateUrl  String?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@unique([employeeId, certCode])
  @@index([employeeId])
  @@index([certType])
  @@index([status])
  @@index([expiryDate])
}

model ComplianceGap {
  id              String          @id @default(cuid())
  
  // Reference
  employeeId      String
  employee        User            @relation("ComplianceGapEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  
  // Gap details
  gapType         ComplianceGapType
  description     String          @db.Text
  
  // Assignment
  assignedToId    String?
  assignedTo      User?           @relation("ComplianceGapAssignedTo", fields: [assignedToId], references: [id])
  
  // Tracking
  identifiedDate  DateTime        @default(now())
  dueDate         DateTime
  resolvedDate    DateTime?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([employeeId])
  @@index([gapType])
  @@index([dueDate])
}

// ============================================================================
// POINT 4.5 - SUPPLIER MANAGEMENT MODELS
// ============================================================================

model Supplier {
  id              String          @id @default(cuid())
  
  // Supplier details
  supplierCode    String          @unique
  name            String
  supplierType    SupplierType
  
  // Contact
  contactPerson   String?
  email           String?
  phone           String?
  address         String?
  
  // Status
  status          SupplierStatus  @default(PROSPECT)
  approvedDate    DateTime?
  approvedById    String?
  approvedBy      User?           @relation("SupplierApprovedBy", fields: [approvedById], references: [id])
  
  // Assessment
  assessmentScore Float?          // 0-100
  lastAssessmentDate DateTime?
  
  // Relations
  audits          SupplierAudit[]
  compliance      SupplierCompliance[]
  documents       SupplierDocument[]
  purchaseOrders  SupplierPurchaseOrder[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([status])
  @@index([supplierType])
}

model SupplierAudit {
  id              String          @id @default(cuid())
  
  // Reference
  supplierId      String
  supplier        Supplier        @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  // Audit details
  auditCode       String
  status          SupplierAuditStatus @default(PLANNED)
  title           String
  scope           String?         @db.Text
  
  // Dates
  plannedDate     DateTime
  auditDate       DateTime?
  
  // Results
  findings        String?         @db.Text
  score           Float?
  
  // Assignment
  auditorId       String
  auditor         User            @relation("SupplierAuditor", fields: [auditorId], references: [id])
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@unique([supplierId, auditCode])
  @@index([supplierId])
  @@index([status])
}

model SupplierCompliance {
  id              String          @id @default(cuid())
  
  // Reference
  supplierId      String
  supplier        Supplier        @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  // Compliance item
  requirement     String
  status          String          // COMPLIANT, NON_COMPLIANT, PENDING, N/A
  
  // Tracking
  checkDate       DateTime        @default(now())
  dueDate         DateTime?
  
  // Evidence
  evidence        String?
  notes           String?         @db.Text
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([supplierId])
  @@index([status])
}

model SupplierDocument {
  id              String          @id @default(cuid())
  
  // Reference
  supplierId      String
  supplier        Supplier        @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  // Document
  docType         String          // CERTIFICATE, LICENSE, QUALITY_POLICY, etc
  fileName        String
  fileUrl         String
  
  // Tracking
  uploadedDate    DateTime        @default(now())
  expiryDate      DateTime?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([supplierId])
  @@index([docType])
}

model SupplierPurchaseOrder {
  id              String          @id @default(cuid())
  
  // PO details
  poNumber        String          @unique
  supplierId      String
  supplier        Supplier        @relation(fields: [supplierId], references: [id])
  
  // Items
  description     String          @db.Text
  quantity        Int
  unit            String          // pieces, kg, hours, etc
  unitPrice       Float
  totalAmount     Float
  
  // Status
  status          SupplierPOStatus @default(DRAFT)
  
  // Dates
  poDate          DateTime        @default(now())
  dueDate         DateTime
  deliveryDate    DateTime?
  
  // Assignment
  createdById     String
  createdBy       User            @relation("POCreatedBy", fields: [createdById], references: [id])
  
  approvedById    String?
  approvedBy      User?           @relation("POApprovedBy", fields: [approvedById], references: [id])
  
  // Notes
  notes           String?         @db.Text
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([supplierId])
  @@index([status])
  @@index([poDate])
}

// ============================================================================
// RELATION UPDATES NEEDED IN EXISTING MODELS:
// ============================================================================
// User model: Add relations for QMS
// - nonconformitiesAssigned  NonconformityRecord[]
// - nonconformitiesVerified  NonconformityRecord[] @relation("NonconformityVerifier")
// - auditTrails              AuditTrail[]
// - qmsDocumentsReviewed     QMSDocument[]
// - qmsReportsApproved       QMSReport[]
//
// User model: Add relations for Document Control
// - documentsCreated         DocumentControl[] @relation("DocumentCreatedBy")
// - documentRevisionsCreated DocumentRevision[] @relation("DocumentRevisionCreatedBy")
// - documentApprovalsAssignedTo DocumentApproval[] @relation("DocumentApprovalAssignedTo")
// - documentApprovalsApprovedBy DocumentApproval[] @relation("DocumentApprovalApprovedBy")
// - documentDistributionsReceived DocumentDistribution[] @relation("DocumentDistributionRecipient")
// - documentAcknowledgements DocumentAcknowledgement[] @relation("DocumentAcknowledgement")
//
// Crew model: Add relations for QMS
// - qmsDocuments             QMSDocument[]
// - nonconformities          NonconformityRecord[]
//
// CrewDocument model: Add relation for QMS
// - qmsDocuments             QMSDocument[]
