name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build application
        run: npm run build

      - name: Deploy to VPS
        env:
          VPS_IP: ${{ secrets.VPS_IP }}
          VPS_USER: ${{ secrets.VPS_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          VPS_APP_DIR: /var/www/hims-app
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $VPS_IP >> ~/.ssh/known_hosts

          # Upload build artifacts using rsync (faster than rebuilding on VPS)
          rsync -avz --delete \
            -e "ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=10 -o ConnectTimeout=30 -i ~/.ssh/id_rsa" \
            --exclude='.git' --exclude='node_modules' --exclude='.next/cache' \
            .next/ $VPS_USER@$VPS_IP:$VPS_APP_DIR/.next/

          rsync -avz \
            -e "ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=10 -o ConnectTimeout=30 -i ~/.ssh/id_rsa" \
            --exclude='.git' --exclude='node_modules' --exclude='.next' \
            package*.json prisma/ public/ $VPS_USER@$VPS_IP:$VPS_APP_DIR/

          # Execute deployment commands on VPS
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=10 -o ConnectTimeout=30 -i ~/.ssh/id_rsa $VPS_USER@$VPS_IP << 'EOFSH'
          set -e
          cd /var/www/hims-app

          # Install production dependencies only
          npm ci --omit=dev

          # Generate Prisma client
          npx prisma generate

          # Restart PM2
          pm2 delete hims-app || true
          pm2 start ecosystem.config.js
          sleep 3

          # Health check
          if ! curl -f http://localhost:3000/api/health; then
            echo "✗ Health check failed!"
            pm2 logs hims-app --lines 50
            exit 1
          fi

          echo "✓ Deployment successful!"
          EOFSH

      - name: Notify deployment
        if: success()
        run: echo "✓ Application deployed successfully to VPS"

      - name: Notify failure
        if: failure()
        run: |
          echo "✗ Deployment failed!"
          exit 1
