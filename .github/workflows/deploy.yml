name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build application
        run: npm run build
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Create deployment archive
        run: |
          tar -czf deploy.tar.gz \
            .next/standalone \
            .next/static \
            public \
            prisma/schema.prisma \
            package.json \
            package-lock.json \
            ecosystem.config.js \
            deploy/config/pm2/ecosystem.config.js

      - name: Deploy to VPS
        env:
          VPS_IP: ${{ secrets.VPS_IP }}
          VPS_USER: ${{ secrets.VPS_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          VPS_APP_DIR: /var/www/hims-app
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $VPS_IP >> ~/.ssh/known_hosts

          # Transfer deployment archive to VPS
          scp -i ~/.ssh/id_rsa deploy.tar.gz $VPS_USER@$VPS_IP:/tmp/deploy.tar.gz

          # Execute deployment commands on VPS
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=10 -o ConnectTimeout=30 -i ~/.ssh/id_rsa $VPS_USER@$VPS_IP << 'EOFSH'
          set -e
          cd /var/www/hims-app

          # Backup current deployment
          if [ -d ".next" ]; then
            mv .next .next.backup.$(date +%Y%m%d_%H%M%S) || true
          fi

          # Extract new deployment
          tar -xzf /tmp/deploy.tar.gz
          rm /tmp/deploy.tar.gz

          # Verify .env file exists
          if [ ! -f ".env" ]; then
            echo "✗ Error: .env file not found on VPS"
            echo "Please create .env file with required environment variables"
            exit 1
          fi

          # Generate Prisma client for production
          npx prisma generate

          # Restart PM2
          pm2 delete hims-app || true
          pm2 start ecosystem.config.js
          sleep 5

          # Health check
          if ! curl -f http://localhost:3000/api/health; then
            echo "✗ Health check failed!"
            pm2 logs hims-app --lines 50
            exit 1
          fi

          # Clean up old backups (keep last 3)
          ls -dt .next.backup.* 2>/dev/null | tail -n +4 | xargs rm -rf || true

          echo "✓ Deployment successful!"
          EOFSH

      - name: Notify deployment
        if: success()
        run: echo "✓ Application deployed successfully to VPS"

      - name: Notify failure
        if: failure()
        run: |
          echo "✗ Deployment failed!"
          exit 1
